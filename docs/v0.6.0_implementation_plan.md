# v0.6.0 実装計画

**対象バージョン**: v0.6.0
**作成日**: 2024-12-28
**工数見積もり**: 4-5日

---

## 1. 実装ステップ

### Phase 1: データ構造とParser（Day 1）

#### 1.1 CodeHeaderInfo拡張
**ファイル**: `Sources/Models/CodeHeaderInfo.swift`（新規）
**内容**:
```swift
struct CodeHeaderInfo: Codable, Hashable {
    let filePath: String
    let lastModified: Date
    let purposes: [String]
    let features: [String]
    let containedTypes: [String: String]?
    let relatedTypes: [String]?
    let hasCodeHeaderFormat: Bool
    var embeddingVector: [Float]?        // 追加
    var embeddingGeneratedAt: Date?      // 追加
}
```
**工数**: 30分

#### 1.2 CodeHeaderParser実装
**ファイル**: `Sources/CodeHeaderParser.swift`（新規）
**内容**:
- `parse(filePath:) -> CodeHeaderInfo?`
- マーカー検出
- セクション抽出（目的、主要機能、含まれる型、関連型）
**工数**: 2-3時間

#### 1.3 単体テスト
**内容**: CodeHeaderParserのテスト
**工数**: 1時間

**Day 1合計**: 4-5時間

---

### Phase 2: NLEmbedding統合（Day 2）

#### 2.1 SemanticSearchEngine実装
**ファイル**: `Sources/NaturalLanguage/SemanticSearchEngine.swift`（新規）
**内容**:
```swift
struct SemanticSearchEngine {
    init() throws
    func generateEmbedding(for text: String) throws -> [Float]
    func search(query:cache:section:layer:threshold:) throws -> [SearchResult]
    func cosineSimilarity(_ a: [Float], _ b: [Float]) -> Double
}
```
**工数**: 3-4時間

#### 2.2 Float配列拡張
**ファイル**: `Sources/Extensions/Array+Float.swift`（新規）
**内容**: コサイン類似度計算のヘルパー
**工数**: 30分

#### 2.3 NLEmbedding利用可能性チェック
**内容**:
```swift
guard let embedding = NLEmbedding.wordEmbedding(for: .japanese) else {
    throw CodeHeaderDBError.embeddingUnavailable
}
```
**工数**: 30分

**Day 2合計**: 4-5時間

---

### Phase 3: ProjectMemory拡張（Day 3）

#### 3.1 ProjectMemory.Memory拡張
**ファイル**: `Sources/ProjectMemory.swift`
**内容**:
```swift
struct Memory: Codable {
    var codeHeaderCache: [String: CodeHeaderInfo] = [:]
    var embeddingDimension: Int = 768
    var lastDBBuildDate: Date?
}
```
**工数**: 1時間

#### 3.2 DB構築メソッド
**ファイル**: `Sources/ProjectMemory.swift`
**内容**:
```swift
func buildCodeHeaderDB(projectPath: String) async throws
func needsDBUpdate() -> Bool
```
**工数**: 3-4時間

#### 3.3 進捗表示
**内容**: DB構築中の進捗ログ
**工数**: 30分

**Day 3合計**: 4-5時間

---

### Phase 4: MCPツール実装（Day 4）

#### 4.1 SearchCodeHeadersTool
**ファイル**: `Sources/Tools/CodeHeader/SearchCodeHeadersTool.swift`（新規）
**内容**:
- Tool定義
- execute()実装
- 結果フォーマット
**工数**: 2-3時間

#### 4.2 GetCodeHeaderStatsTool
**ファイル**: `Sources/Tools/CodeHeader/GetCodeHeaderStatsTool.swift`（新規）
**内容**:
- Tool定義
- execute()実装
- 統計情報収集・フォーマット
**工数**: 2時間

#### 4.3 SwiftMCPServer統合
**ファイル**: `Sources/SwiftMCPServer.swift`
**内容**:
- ListToolsに2ツール追加
- CallToolにcase追加
**工数**: 30分

**Day 4合計**: 4-5時間

---

### Phase 5: テスト・デバッグ（Day 5）

#### 5.1 DEBUGビルドテスト
**内容**:
```bash
./register-selena-to-claude-code-debug.sh
# Claude Code再起動
mcp__swift-selena-debug__initialize_project(...)
mcp__swift-selena-debug__search_code_headers(query: "電話番号")
mcp__swift-selena-debug__get_code_header_stats()
```
**工数**: 2時間

#### 5.2 パフォーマンステスト
**内容**:
- DB構築時間測定（200ファイル）
- 検索時間測定
- メモリ使用量測定
**工数**: 1時間

#### 5.3 検索精度テスト
**内容**:
- 実プロジェクト（ContactB）で10-20クエリ
- 精度測定
**工数**: 2時間

#### 5.4 バグ修正
**工数**: 2-3時間

**Day 5合計**: 7-8時間

---

## 2. 工数見積もり

| Phase | 内容 | 工数 |
|-------|------|------|
| Phase 1 | データ構造・Parser | 4-5時間 |
| Phase 2 | NLEmbedding統合 | 4-5時間 |
| Phase 3 | ProjectMemory拡張 | 4-5時間 |
| Phase 4 | MCPツール実装 | 4-5時間 |
| Phase 5 | テスト・デバッグ | 7-8時間 |
| **合計** | | **23-28時間** |

**実稼働日数**: 4-5日（1日5-6時間作業）

---

## 3. リスクと対策

### R1: NLEmbeddingが遅い

**リスク**: 埋め込み生成が想定より遅い

**対策**:
- Day 2で早期にベンチマーク
- 並行処理で高速化
- 必要に応じてバッチ処理

### R2: 検索精度が80%未満

**リスク**: セマンティック検索でも精度不足

**対策**:
- 閾値調整（0.6 → 0.5）
- セクション別検索の推奨
- v0.6.1で類義語辞書追加

### R3: メモリ使用量超過

**リスク**: 埋め込みベクトルで50MB超

**対策**:
- 次元数確認
- 圧縮の検討
- オンデマンドロード

---

## 4. マイルストーン

| 日付 | マイルストーン |
|-----|-------------|
| Day 1 | Phase 1完了 - Parser実装 |
| Day 2 | Phase 2完了 - NLEmbedding統合 |
| Day 3 | Phase 3完了 - ProjectMemory拡張 |
| Day 4 | Phase 4完了 - MCPツール実装 |
| Day 5 | Phase 5完了 - テスト・デバッグ |
| Day 6 | リリース準備（ドキュメント更新） |

---

## 5. 成功基準

- [ ] search_code_headersが動作
- [ ] get_code_header_statsが動作
- [ ] パフォーマンス目標達成（DB構築<15秒、検索<0.1秒）
- [ ] 検索精度80%以上
- [ ] CHANGELOG.md更新
- [ ] README.md更新

---

**作成者**: Claude Code
**最終更新**: 2024-12-28
