# 対話履歴の保存

検討してきた内容、対話した内容を `docs/history/CONVERSATION_HISTORY.md` に記録する。

---

## ファイル構成

```
docs/history/
├── CONVERSATION_HISTORY.md  # 現行ファイル
└── archive/                  # アーカイブ
    └── CONVERSATION_HISTORY_YYYYMMDD.md
```

---

## 運用ルール

| 項目 | 基準 |
|------|------|
| サマリー | 最大500行（アーカイブした会話から抽出した重要な教訓） |
| 詳細履歴 | 最大1000行 |
| 合計 | 1500行目安 |
| 1500行超過時 | 古い詳細履歴をarchive/に移動（日付付きファイル名） |

---

## 重要度ランク（5段階）

| ランク | 基準 | まとめ時 |
|--------|------|----------|
| ★★★★★ | アーキテクチャルール変更、重大バグ修正、私の誤りパターン | サマリーに残す |
| ★★★★☆ | 設計判断の重要な変更 | サマリーに残す |
| ★★★☆☆ | 要件変更の経緯 | 見出しと結論だけ残す |
| ★★☆☆☆ | 実装進捗の詳細 | アーカイブ候補 |
| ★☆☆☆☆ | 作業ログ | 記録しない |

---

## 記録すべき内容

| 記録する | 記録しない |
|---------|-----------|
| 設計判断とその理由 | 単純な作業ログ |
| バグの根本原因と修正 | タスク完了報告（main_plan.mdで管理）|
| ルール追加/変更の経緯 | コードの詳細（コード自体を見ればわかる）|
| ユーザーからの重要な指摘 | 一時的なエラー対応 |
| 私の誤りパターン | |

---

## 書き方のルール [CRITICAL]

### 1. 対象を必ず明示する

**悪い例**:
```markdown
- キーワードインデックス削除
- タスク粒度を合わせる
```

**良い例**:
```markdown
- **docs/docs_toc.md内「キーワードインデックス」セクション**: 削除
- **docs/docs_toc.md内「タスク別リファレンス」**: main_plan.mdの粒度に合わせる
```

### 2. 対象の種類

| 対象 | 書き方 |
|------|--------|
| ファイル全体 | `**docs/docs_toc.md**:` |
| ファイル内セクション | `**docs/docs_toc.md内「セクション名」**:` |
| コード | `**Domain/Service/XxxService.swift**:` またはコードブロック内にコメント |
| ユーザー発言 | `#### ユーザー指摘（原文）` + 引用ブロック |

### 3. ユーザー指摘は原文を引用

```markdown
#### ユーザー指摘（原文）
> 「Serviceにget関数はいらない。バグの素」
> 「ServiceはStreamで通知すべき」
```

### 4. コード例にはファイルパスを記載

```swift
// Domain/Service/BusinessCardScanService.swift
private let contactRepository: ContactRepositoryType  // Protocol経由でDI注入
```

---

## ファイル構造

```markdown
# 対話履歴

このファイルは、プロジェクトにおける重要な設計判断や検討内容の履歴を記録します。

## 重要な教訓（サマリー）

### カテゴリ名 [★★★★★]

- **教訓タイトル**
  - 対象: `ファイルパス` または `ファイル内セクション`
  - 理由: なぜそうすべきか
  - 正解: どうすべきか

---

## 詳細履歴

### YYYY-MM-DD: タイトル [★★★★★]

#### 問題
[何が問題だったか]

#### ユーザー指摘（原文）
> 「引用」

#### 結論
[最終的にどうしたか]

#### 変更内容
- **対象ファイル/セクション**: 変更内容

---

## アーカイブ

詳細な履歴は `archive/` ディレクトリを参照:
- `CONVERSATION_HISTORY_YYYYMMDD.md`
```

---

## 実行手順

1. `docs/history/CONVERSATION_HISTORY.md` を読み込む
2. 今回の対話内容を上記フォーマットで追記
3. 行数を確認（800行超過ならアーカイブ処理）
4. 保存

---

## アーカイブ手順（800行超過時）

1. 古い詳細履歴を `archive/CONVERSATION_HISTORY_YYYYMMDD.md` に移動
2. サマリーは維持（必要に応じて更新）
3. `CONVERSATION_HISTORY.md` の「アーカイブ」セクションにファイル名を追記
